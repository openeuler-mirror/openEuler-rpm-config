From f5e80fa103926a1eaaae7bc062673eb10ff9370d Mon Sep 17 00:00:00 2001
From: liyunfei <liyunfei33@huawei.com>
Date: Thu, 17 Aug 2023 19:44:14 +0800
Subject: [PATCH] [Backport] Call %set_build_flags before %build, %check, and
 %install stages

https://fedoraproject.org/wiki/Changes/SetBuildFlagsBuildCheck

Originally by: tstellar
---
 macros | 8 ++++++++
 1 file changed, 8 insertions(+)

diff --git a/macros b/macros
index 47a20f5..f4468cd 100755
--- a/macros
+++ b/macros
@@ -81,6 +81,13 @@
   CXX=%{__cxx}; export CXX ; \
   CCC="${CCC:-%{__cxx}}" ; export CCC
 
+# Automatically use set_build_flags macro for build, check, and
+# install phases.
+# Use "%undefine _auto_set_build_flags" to disable"
+%_auto_set_build_flags 1
+%__spec_build_pre %{___build_pre} %{?_auto_set_build_flags:%{set_build_flags}}
+%__spec_check_pre %{___build_pre} %{?_auto_set_build_flags:%{set_build_flags}}
+
 #For backwards compatibility only.
 %__global_cflags %{build_cflags}
 %__global_cxxflags %{build_cxxflags}
@@ -141,6 +148,7 @@
     [ "$RPM_BUILD_ROOT" != "/" ] && rm -rf "${RPM_BUILD_ROOT}"\
     mkdir -p `dirname "$RPM_BUILD_ROOT"`\
     mkdir "$RPM_BUILD_ROOT"\
+    %{?_auto_set_build_flags:%{set_build_flags}}\
 %{nil}
 
 # ---- Expanded at end of %install scriptlet.
-- 
2.27.0

